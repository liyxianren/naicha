# 计算端修复与增强规划

本文档梳理当前计算/支付链路与规则的差距，并给出分阶段的落地计划，确保市场调研、广告、研发、生产、客流分配符合游戏规则。

## 目标与范围
- 首轮即可正常分配高/低消费客户，不再因初始口碑为 0 而只卖给高消费客户。
- 广告、调研、研发、生产成本正确扣费并同步到计算端。
- 研发解锁状态、生产力分配、定价锁规则生效，前端状态与后端一致。
- 客流分配逻辑满足规则且能处理并列场景，回合推进和结算数据可用。

## 规则要点（摘录）
- 市场调研：执行则扣 500，刷新下一回合客流（脚本/标记）。
- 广告：执行则扣 800，线下掷骰广告分写入本回合计算。
- 研发：执行则扣 600，成功解锁配方；失败不解锁但仍扣费。
- 配方与圈粉率：7 个配方，难度与圈粉率如需求；未解锁灰色，解锁后可分配生产力与定价。
- 原料成本：茶 6、奶 4、水果 5、配料 2；每种原料当回合购入量每满 50 份价 -10%，可累加，最低 50%。
- 定价锁：每 3 回合可调整一次。
- 口碑：广告分 + 圈粉率 × 累计总销售杯数（含历史）。
- 客流分配：
  - 高消费：口碑降序，价升序，平分并列；先占用生产力。
  - 低消费：价升序，口碑>0，口碑降序，平分并列；使用剩余生产力。

## 当前问题初判
- 初始口碑为 0，导致首轮低消费客户不买；高消费按口碑排序后可能独占。
- 成本扣费/广告分/调研标记/研发成功状态与计算端同步缺失或不完整。
- 定价锁、批量折扣、生产力上限校验需对齐规则。
- 回合结算到前端“继续游戏”刷新逻辑已修复，但需验证完整回合流转。

## 落地计划
1) **规则对齐与数据源梳理**
   - 阅读 `calculation_engine.py`、`production_service.py`、`round_service.py`、`market/*` 现有实现，对照规则列出差距清单。
   - 明确广告分、调研、研发成功状态在模型/表中的字段和生命周期。

2) **口碑与初始基线修正**
   - 为未售出产品设定最小正口碑（如使用圈粉率或固定下限），避免首轮低消费全跳过。
   - 确保广告分 + 圈粉率 × 累计销量公式生效，累计销量包含历史。
   - 广告分写入回合数据（提交市场行动时持久化）。

3) **决策扣费与状态同步**
   - 市场调研：扣 500 现金，记录调研标记供下一回合客流脚本使用。
   - 广告：扣 800 现金，记录广告分到计算端（与口碑计算共享）。
   - 研发：扣 600 现金；成功则解锁配方（玩家产品/配方表），失败不解锁但仍扣费。
   - 生产：按配方和批量折扣计算原料成本并扣费；遵守生产力上限和定价锁。

4) **前端展示与输入对齐**
   - 生产面板：显示 7 个配方的难度、圈粉率、配方、解锁/灰态；研发成功即点亮。
   - 汇总奶茶师生产力为可分配上限，实时校验提交不超额。
   - 定价锁提示：距离上次调价未满 3 回合禁用价格输入。

5) **客流分配算法完善**
   - 高消费：口碑降序、价升序、平分并列；售完为止。
   - 低消费：价升序、过滤口碑>0、口碑降序、平分并列；使用剩余库存。
   - 处理并列平分、随机分配余数时保证不超库存；记录剩余未满足客户。
   - 将销量、营收回写生产记录，累计销售更新到产品。

6) **回合流转与结算**
   - 推进回合前校验所有活跃玩家已提交生产。
   - 生成回合 summary（销量、营收、利润、口碑、剩余客流），前端展示后进入下一回合不刷新页面。
   - 清空当回合的广告/调研临时字段，为下回合准备。

7) **验证与测试**
   - 构造首轮全部口碑为 0 的用例，验证低/高客流分配符合规则。
   - 覆盖：批量折扣成本、价格锁校验、广告/调研/研发扣费与状态、客流平分逻辑、回合推进校验。
   - 后端加 pytest 场景；前端手测一回合提交与“继续游戏”流畅性。

## 产出物
- 更新的计算/服务层实现（广告/调研/研发/生产/客流）。
- 前端生产/决策界面状态与校验调整。
- 测试用例与手测脚本。

## 里程碑
1. 规则梳理与口碑基线修正完成，首轮分配正常。
2. 决策扣费与状态同步完成，生产成本/定价锁对齐。
3. 客流分配与回合流转完成，结算展示正确。
4. 测试通过并完成手动回合验证。
